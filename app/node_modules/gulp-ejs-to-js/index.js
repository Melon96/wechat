'use strict';
var through = require('through2');
var path = require('path');

var gutil = require('gulp-util');
var PluginError = gutil.PluginError;


// 常量
const PLUGIN_NAME = 'gulp-ejs2js';
/**
 * 把ejs转成js
 * 目的是为了可以和js一起打包，避免额外的请求
 * @param  {[type]} opt [description]
 * @return {[type]}     [description]
 */
module.exports = function(opt) {
    opt = opt || {minify: true};
    var basepath = opt.basepath || '';
    var prefix = opt.prefix || '';
    function doSomething(file, encoding, callback) {
 
        if (file.isNull()) {
            throw new PluginError(PLUGIN_NAME, 'file is not exist!');
        }
 
        if (file.isStream()) {
            throw new PluginError(PLUGIN_NAME, 'Streaming not supported!');
        }

　　　　//do something
        var fileName = '';
        if (basepath) {
            fileName = path.normalize(file.path).replace(path.resolve(basepath), '');
        } else {
            fileName = path.basename(file.path);
        }
        fileName = prefix + fileName.replace(/\..*/, ".html").replace(/\\/g, '/');
        var newContents = 'window._TEMPLATE=window._TEMPLATE||{};window._TEMPLATE[\'' + fileName + '\']=';

        var contents = file.contents.toString();
        // contents = contents.replace(/"/g, '\\"');
        contents = contents.replace(/'/g, "\\'");
        //是否压缩文件
        if(opt.minify === true){
            newContents = newContents.replace('\n', '');
            newContents += '\'' + contents.replace(/\s+/g, " ") + '\'';

        }else{

            var texts = [];
            contents = contents.split(/\r?\n/ig);
            contents.forEach(function(line, index){
                texts[index] = '"' + line + (index === contents.length - 1 ? '"' : '"\n');
            });
            newContents += texts.join('+');
        }

        newContents += ';'
        
        file.contents = new Buffer(newContents);
        file.path = file.path.replace(".ejs", ".js");
 
        callback(null, file);
    }
 
    return through.obj(doSomething);
};
